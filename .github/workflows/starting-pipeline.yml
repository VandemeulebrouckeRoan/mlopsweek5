name: first-pipeline

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build-push-run:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Print Hello
      run: echo "Pipeline running âœ… on SELF-HOSTED runner!"

    # --- FIX DOCKER LOGIN ON WINDOWS ---
    - name: Disable Docker credential helper on Windows
      shell: pwsh
      run: |
        mkdir -Force $HOME\.docker
        '{"credsStore":""}' | Set-Content "$HOME\.docker\config.json"

    - name: Login to GHCR
      shell: bash
      env:
        GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
        GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      run: |
        echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin

    - name: Set variables
      run: |
        echo "IMAGE_NAME=hello-world-nginx" >> $GITHUB_ENV
        echo "TAG=$(echo ${GITHUB_SHA::8})" >> $GITHUB_ENV
      shell: bash

    - name: Build Docker image
      shell: bash
      run: |
        docker build -t ghcr.io/${{ secrets.GHCR_USERNAME }}/$IMAGE_NAME:$TAG .

    - name: Push Docker image to GHCR
      shell: bash
      run: |
        docker push ghcr.io/${{ secrets.GHCR_USERNAME }}/$IMAGE_NAME:$TAG

    - name: Run Docker container
      shell: bash
      run: |
        docker run -d --rm -p 8080:80 --name test ghcr.io/${{ secrets.GHCR_USERNAME }}/$IMAGE_NAME:$TAG
        sleep 3
        curl -I http://localhost:8080

    - name: Cleanup container
      shell: bash
      run: |
        docker stop test || true
