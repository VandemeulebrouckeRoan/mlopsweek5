name: Starting Pipeline

on:
  workflow_dispatch:

jobs:
  first-pipeline:
    runs-on: self-hosted

    steps:
    - name: Check out code repository
      uses: actions/checkout@v4

    - name: Print Hello
      run: echo "Pipeline is running âœ…"

    # âœ… Build Docker image
    - name: Build Docker image
      shell: powershell
      run: |
        $IMAGE_NAME = "hello-world-nginx"
        $TAG = "${{ github.ref_name }}-${{ github.sha }}"
        echo "Using tag $TAG"
        
        docker build -t "$IMAGE_NAME`:$TAG" .

    # âœ… Run Docker container & test response
    - name: Run Docker container
      shell: powershell
      run: |
        $IMAGE_NAME = "hello-world-nginx"
        $TAG = "${{ github.ref_name }}-${{ github.sha }}"
        echo "Running $IMAGE_NAME`:$TAG"

        # Stop/remove any existing container on port 8080
        docker ps -aq --filter "name=test-container" | ForEach-Object { docker stop $_; docker rm $_ }

        docker run -d -p 8080:80 --name test-container "$IMAGE_NAME`:$TAG"
        Start-Sleep -Seconds 5

        # Request to verify container works
        Invoke-WebRequest -Uri "http://localhost:8080" -Method Head
        echo "Container responded âœ…"

    # âœ… Cleanup container after test
    - name: Cleanup Docker
      if: always()
      shell: powershell
      run: |
        docker ps -aq --filter "name=test-container" | ForEach-Object { docker stop $_; docker rm $_ }
        echo "Cleanup complete ðŸ§¹"
