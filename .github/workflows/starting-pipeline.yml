name: Starting Pipeline

on:
  workflow_dispatch:

jobs:
  first-pipeline:
    runs-on: self-hosted

    steps:
    # ✅ Checkout repo
    - name: Check out code repository
      uses: actions/checkout@v4

    # ✅ Test runner
    - name: Print Hello
      shell: powershell
      run: echo "Pipeline running ✅ on SELF-HOSTED runner!"

    # ✅ Login to GitHub Container Registry
    - name: Login to GHCR
      shell: powershell
      run: |
        # Disable credential helper for Docker in this session
        Set-Content "$HOME/.docker/config.json" '{ "credsStore": "" }'
        
        $token = "${{ secrets.GITHUB_TOKEN }}"
        $user = "${{ github.actor }}"

        $token | docker login ghcr.io -u $user --password-stdin

    # ✅ Build Docker image
    - name: Build Docker image
      shell: powershell
      run: |
        $IMAGE_NAME="hello-world-nginx"
        $TAG="${{ github.ref_name }}-${{ github.sha }}"
        echo "Building $IMAGE_NAME:$TAG"
        docker build -t ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:$TAG .

    # ✅ Push Docker image
    - name: Push Docker image
      shell: powershell
      run: |
        $IMAGE_NAME="hello-world-nginx"
        $TAG="${{ github.ref_name }}-${{ github.sha }}"
        echo "Pushing $IMAGE_NAME:$TAG"
        docker push ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:$TAG

    # ✅ Run container to test
    - name: Run Docker container
      shell: powershell
      run: |
        $IMAGE_NAME="hello-world-nginx"
        $TAG="${{ github.ref_name }}-${{ github.sha }}"
        docker run -d -p 8080:80 --name test-container ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME:$TAG
        sleep 5
        Invoke-WebRequest -Uri http://localhost:8080 | Select-Object StatusCode

    # ✅ Cleanup container
    - name: Cleanup Docker
      shell: powershell
      run: |
        docker stop test-container
        docker rm test-container
